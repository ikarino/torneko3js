# torneko3js
PS2ゲーム「トルネコ3」のJavaScriptライブラリです。

このライブラリは[scs](https://github.com/ikarino/scs)の移植が中心ですが、
モンスターの能力値を計算する等の機能を備えています。

## インストール

### Nodejsの場合
```
npm install --save torneko3js
```

### ブラウザの場合
[sample/index.html](http://github.com/ikarino/torneko3js/sample/index.html)を参照してください。
```html
  <script src="torneko3.bundle.js"></script>
  <script type="text/javascript">
    var torneko3 = require('torneko3');
    var inp = torneko3.sampleSCSInputs["4キラーマ倍速"];
    var m = new torneko3.Manager(inp);
    m.trial();
    document.getElementById("input").innerText = JSON.stringify(inp, null , "　　");
    document.getElementById("result").innerText = JSON.stringify(m.toJson(), null , "　　");
  </script>
```

## 使い方の例
```js
import { Manager, sampleSCSInputs } from 'torneko3js';

const inp = sampleSCSInputs['4キラーマ倍速'];
const m = new Manager(inp);
m.trial();
console.log(m.toJson());
```

## 実装
### システム
- [x] scs移植
- [x] kompotaさんの分裂方向
- [x] はぐれ状態ホイミン（転ばぬ先の杖さんの半ホイミンに必要）

### 特技
- [x] キラーマ
- [x] さそりかまきり
- [x] ホイミン
- [x] キノコ
- [x] メルモン／ハエール／はねせんにん
- [x] フライダ／ランガス／レイマン
- [x] ミスター／イッシー
- [x] ラブレス／ドラゴス／ドラタル
- [ ] コロリン／エミリー
- [ ] シャイト
- [ ] 力をためる系（レノファイター／グレートホーン／あくましんかん）
- [ ] リリー／ドック
- [ ] ドランゴ
- [ ] ギーガ
- [ ] 敵に効果なし系（ゾンマス／シャアマ／ボーンズ／どろにんぎょう／ビータン）
- [ ] 単体状態異常系（タンギー／トビー／だいまどう／キャロン／めふらん／テンツク／ラステン／まどうし）
- [ ] オーメン／ラプラス
- [ ] デマシン
- [ ] 貝系（ツノーガ／しびれマイマイ）
- [ ] 人手系（バヒート／マスター）
- [ ] 氷系（ヒョウマ／ビート／ラキッズ／メラード）
- [x] キートン／ようじは封印が前提となるため実装しない
- [x] カエル系は封印が前提となるため実装しない
- [x] 爆発系（デビアン／リビハン／ラスター／バクサン／ガルロ）は実装しない
- [x] マイケルはscsを根本から見直す必要があるので実装しない
- [x] ゲーツはスモコンに悪影響なので実装しない
- [x] ダースはスモコンに悪影響なので実装しない
- [x] コロマージはバイキルトが悪影響なので実装しない
- [x] ジャックは意味が無いので実装しない
- [x] 鈍足（アイアンタートル）は面倒なので実装しない
- [x] モストンは複雑すぎるので実装しない

### 受身形効果
- [x] スモグル
- [ ] ラリアン
- [ ] じごくのよろい
- [x] モストン／おどるほうせき
- [x] カニ系や魔法無効化系はスモコン／ブラコンに影響しないので実装しない
- [x] ゾンビ系のホイミは確実に倒れるので実装しない


### その他
- [ ] 行動順補助用の関数

### ホイミンの行動

1. 周囲の傷ついたキャラの数を取得
1. ホイミ発動を判断（ランダム） ← ダメージを負ったユニットごとに判定するモデル
1. 攻撃可能なキャラの数を取得
1. 攻撃を判断（ランダム） ← 攻撃可能なユニットごとに判定するモデル
1. 移動可能なマスの数を取得
1. いっしょにいてね、はぐれ状態の場合、移動を判断（ランダム）

### 能力値の管理

#### 最大HP（整数）
1. モンスター名とレベルから最大HPを計算
1. ドーピング分を加える

#### 現在HP（実数）
- ダメージを受けた場合、整数値減少する
- ホイミスライム等の特技の効果の場合、整数値増減する
- 自然回復の場合、実数値増加する（仲間のみ）

#### 攻撃力（整数）
1. モンスター名とレベルから攻撃力を計算→整数
1. ドーピング分を加える→整数
1. 弱化回数分だけ0.5倍する。9回の場合は0にする。→実数
1. 小数点以下を切り上げる→整数

#### 防御力（整数）
1. モンスター名とレベルから防御力を計算→整数
1. 弱化回数に応じて防御力を定数倍する。→実数
1. 小数点以下を切り捨てる→整数

### ダメージ計算式
分かりやすく書き直しています。  
4行目のランダム要素は`7/8～9/7`のランダムな数字が入りますが、一様分布とみなすことにしました。

```js
let damage = Math.ceil(this.atk);      // 攻撃力
damage *= 1.3;                         // 1.3倍する
damage *= Math.pow(35/36, enemy.def);  // 防御力を反映
damage *= Math.random()/4 + 7/8;       // ランダム要素
damage = Math.round(damage);           // 四捨五入
if (damage === 0.0) {
  damage = 1.0;                        // ダメージが0の場合は1に変更
}
```